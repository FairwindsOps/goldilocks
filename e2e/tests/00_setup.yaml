version: "2"
name: Setup
vars:
  timeout: 60s
  vpa-wait: 20
  vpa-ref: e0f63c1caeec518f85c4347b673e4e99e4fb0059
testcases:
- name: Install metrics-server
  steps:
  - script: |
      helm repo add bitnami https://charts.bitnami.com/bitnami
      helm repo update
      kubectl create namespace metrics-server
      helm -n metrics-server upgrade --install metrics-server bitnami/metrics-server --set apiService.create=true --set extraArgs.kubelet-insecure-tls=true
- name: Install VPA Recommender
  steps:
  - script: |
      kubectl apply -f https://raw.githubusercontent.com/kubernetes/autoscaler/{{.vpa-ref}}/vertical-pod-autoscaler/deploy/recommender-deployment.yaml
      kubectl apply -f https://raw.githubusercontent.com/kubernetes/autoscaler/{{.vpa-ref}}/vertical-pod-autoscaler/deploy/vpa-v1-crd.yaml
      kubectl apply -f https://raw.githubusercontent.com/kubernetes/autoscaler/{{.vpa-ref}}/vertical-pod-autoscaler/deploy/vpa-rbac.yaml
  - script: kubectl get crd verticalpodautoscalers.autoscaling.k8s.io -oname
    retry: 6
    delay: 5
    assertions:
    - result.code ShouldEqual 0
    - result.systemout ShouldEqual "customresourcedefinition.apiextensions.k8s.io/verticalpodautoscalers.autoscaling.k8s.io"
- name: Install Goldilocks
  steps:
  - script: kubectl create ns goldilocks
  - script: |
      kubectl -n goldilocks apply -f ../../hack/manifests/dashboard/
      kubectl -n goldilocks apply -f ../../hack/manifests/controller/
  - script: |
      kubectl -n goldilocks wait deployment --timeout={{.timeout}} --for condition=available -l app.kubernetes.io/name=goldilocks,app.kubernetes.io/component=dashboard
      kubectl -n goldilocks wait deployment --timeout={{.timeout}} --for condition=available -l app.kubernetes.io/name=goldilocks,app.kubernetes.io/component=controller
